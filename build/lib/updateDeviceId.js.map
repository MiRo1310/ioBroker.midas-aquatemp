{
  "version": 3,
  "sources": ["../../src/lib/updateDeviceId.ts"],
  "sourcesContent": ["import axios from 'axios';\r\nimport { MidasAquatemp } from '../main';\r\nimport { getAxiosUpdateDeviceIdParams } from './axiosParameter';\r\nimport { getUpdateDeviceIdSUrl } from './endPoints';\r\nimport { saveValue } from './saveValue';\r\nimport { initStore } from './store';\r\nimport { updateDeviceStatus } from './updateDeviceStatus';\r\nimport { errorLogger } from './logging';\r\n\r\nlet _this: MidasAquatemp;\r\n\r\nexport async function updateDeviceID(): Promise<void> {\r\n    const store = initStore();\r\n    try {\r\n        if (!_this) {\r\n            _this = MidasAquatemp.getInstance();\r\n        }\r\n        const { token, apiLevel } = store;\r\n        if (!token) {\r\n            return;\r\n        }\r\n        const { sURL } = getUpdateDeviceIdSUrl();\r\n        const options = getAxiosUpdateDeviceIdParams();\r\n        _this.log.debug(`UpdateDeviceID URL: ${sURL}`);\r\n        _this.log.debug(`UpdateDeviceID options: ${JSON.stringify(options)}`);\r\n\r\n        const response = await axios.post(sURL, options, {\r\n            headers: { 'x-token': token },\r\n        });\r\n\r\n        _this.log.debug(`UpdateDeviceID response: ${JSON.stringify(response.data)}`);\r\n        _this.log.debug(`UpdateDeviceID response status: ${JSON.stringify(response.status)}`);\r\n\r\n        if (!response || response.status !== 200 || response.data.error_code !== '0') {\r\n            // Login-Fehler\r\n            store.resetOnErrorHandler();\r\n            return;\r\n        }\r\n\r\n        if (!response.data?.object_result?.[0]?.device_code && !response.data?.objectResult?.[0]?.deviceCode) {\r\n            _this.log.error('Error in updateDeviceID(): No device code found');\r\n            _this.log.error(`Response: ${JSON.stringify(response.data)}`);\r\n            return;\r\n        }\r\n\r\n        if (apiLevel < 3) {\r\n            store.device = response.data.object_result[0]?.device_code;\r\n            store.product = response.data.object_result[0]?.product_id;\r\n            store.reachable = response.data.object_result[0]?.device_status == 'ONLINE';\r\n        } else {\r\n            store.device = response.data.objectResult[0]?.deviceCode;\r\n            store.product = response.data.objectResult[0]?.productId;\r\n            store.reachable = response.data.objectResult[0]?.deviceStatus == 'ONLINE';\r\n        }\r\n        _this.log.debug(`Device: ${store.device}`);\r\n        _this.log.debug(`Product: ${store.product}`);\r\n        _this.log.debug(`Reachable: ${store.reachable}`);\r\n\r\n        await saveValue('DeviceCode', store.device, 'string');\r\n        await saveValue('ProductCode', store.product, 'string');\r\n\r\n        if (store.reachable && store.device) {\r\n            await saveValue('info.connection', true, 'boolean');\r\n            if (store.device != '' && store.product) {\r\n                _this.log.debug('Update device status');\r\n                await updateDeviceStatus();\r\n            }\r\n            return;\r\n        }\r\n        _this.log.debug('Device not reachable');\r\n        store.resetOnErrorHandler();\r\n    } catch (error: any) {\r\n        errorLogger('Error in updateDeviceID', error, _this);\r\n\r\n        (store.token = ''), (store.device = ''), (store.reachable = false);\r\n    }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAkB;AAClB,kBAA8B;AAC9B,4BAA6C;AAC7C,uBAAsC;AACtC,uBAA0B;AAC1B,mBAA0B;AAC1B,gCAAmC;AACnC,qBAA4B;AAE5B,IAAI;AAEJ,eAAsB,iBAAgC;AAXtD;AAYI,QAAM,YAAQ,wBAAU;AACxB,MAAI;AACA,QAAI,CAAC,OAAO;AACR,cAAQ,0BAAc,YAAY;AAAA,IACtC;AACA,UAAM,EAAE,OAAO,SAAS,IAAI;AAC5B,QAAI,CAAC,OAAO;AACR;AAAA,IACJ;AACA,UAAM,EAAE,KAAK,QAAI,wCAAsB;AACvC,UAAM,cAAU,oDAA6B;AAC7C,UAAM,IAAI,MAAM,uBAAuB,IAAI,EAAE;AAC7C,UAAM,IAAI,MAAM,2BAA2B,KAAK,UAAU,OAAO,CAAC,EAAE;AAEpE,UAAM,WAAW,MAAM,aAAAA,QAAM,KAAK,MAAM,SAAS;AAAA,MAC7C,SAAS,EAAE,WAAW,MAAM;AAAA,IAChC,CAAC;AAED,UAAM,IAAI,MAAM,4BAA4B,KAAK,UAAU,SAAS,IAAI,CAAC,EAAE;AAC3E,UAAM,IAAI,MAAM,mCAAmC,KAAK,UAAU,SAAS,MAAM,CAAC,EAAE;AAEpF,QAAI,CAAC,YAAY,SAAS,WAAW,OAAO,SAAS,KAAK,eAAe,KAAK;AAE1E,YAAM,oBAAoB;AAC1B;AAAA,IACJ;AAEA,QAAI,GAAC,0BAAS,SAAT,mBAAe,kBAAf,mBAA+B,OAA/B,mBAAmC,gBAAe,GAAC,0BAAS,SAAT,mBAAe,iBAAf,mBAA8B,OAA9B,mBAAkC,aAAY;AAClG,YAAM,IAAI,MAAM,iDAAiD;AACjE,YAAM,IAAI,MAAM,aAAa,KAAK,UAAU,SAAS,IAAI,CAAC,EAAE;AAC5D;AAAA,IACJ;AAEA,QAAI,WAAW,GAAG;AACd,YAAM,UAAS,cAAS,KAAK,cAAc,CAAC,MAA7B,mBAAgC;AAC/C,YAAM,WAAU,cAAS,KAAK,cAAc,CAAC,MAA7B,mBAAgC;AAChD,YAAM,cAAY,cAAS,KAAK,cAAc,CAAC,MAA7B,mBAAgC,kBAAiB;AAAA,IACvE,OAAO;AACH,YAAM,UAAS,cAAS,KAAK,aAAa,CAAC,MAA5B,mBAA+B;AAC9C,YAAM,WAAU,cAAS,KAAK,aAAa,CAAC,MAA5B,mBAA+B;AAC/C,YAAM,cAAY,cAAS,KAAK,aAAa,CAAC,MAA5B,mBAA+B,iBAAgB;AAAA,IACrE;AACA,UAAM,IAAI,MAAM,WAAW,MAAM,MAAM,EAAE;AACzC,UAAM,IAAI,MAAM,YAAY,MAAM,OAAO,EAAE;AAC3C,UAAM,IAAI,MAAM,cAAc,MAAM,SAAS,EAAE;AAE/C,cAAM,4BAAU,cAAc,MAAM,QAAQ,QAAQ;AACpD,cAAM,4BAAU,eAAe,MAAM,SAAS,QAAQ;AAEtD,QAAI,MAAM,aAAa,MAAM,QAAQ;AACjC,gBAAM,4BAAU,mBAAmB,MAAM,SAAS;AAClD,UAAI,MAAM,UAAU,MAAM,MAAM,SAAS;AACrC,cAAM,IAAI,MAAM,sBAAsB;AACtC,kBAAM,8CAAmB;AAAA,MAC7B;AACA;AAAA,IACJ;AACA,UAAM,IAAI,MAAM,sBAAsB;AACtC,UAAM,oBAAoB;AAAA,EAC9B,SAAS,OAAY;AACjB,oCAAY,2BAA2B,OAAO,KAAK;AAEnD,IAAC,MAAM,QAAQ,IAAM,MAAM,SAAS,IAAM,MAAM,YAAY;AAAA,EAChE;AACJ;",
  "names": ["axios"]
}
